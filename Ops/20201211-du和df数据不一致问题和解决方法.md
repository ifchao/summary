___
- FileName: 20201211-du和df数据不一致问题和解决方法.md
- Author: ihuangch -huangch96@qq.com
- Description: ---
- Create:2020-12-11 15:23:05
___
## 背景
收到磁盘告警，准备清理系统盘，使用 df 命令查看系统磁盘使用情况，发现确实占用很多，使用 du 命令想要找到占用磁盘空间最大的目录，发现 du 命令和 df 命令显示的结果差距很大

## df 与 du 命令的工作原理 
  
- df 命令：
  - df 命令使用的是 statfs 这个系统调用，直接读取分区的超级块信息，获取分区的使用情况。它的数据是基于分区元数据的，所以只能针对整个分区。由于 df 直接读取超级快，所以运行速度也不受文件的的多少影响。

- du 命令
  - du 命令会对需要统计的文件逐个调用 fstat 这个系统调用，获取文件大小。它的数据是基于文件获取的，所以有很大的灵活性，不一定非要针对一个分区，可以跨越多个分区进行操作。如果针对的目录中文件很多，du 速度就会慢很多。

## df 与 du 不一致的原因
1. 当一个文件被删除后，在文件系统目录中已经不见了，所以 du 就不会在统计了。然而如果此时还有运行的进程持有这个已经被删除的文件的句柄的话，这个文件就不会真正的在磁盘中被删除，分区的超级快信息也不会被更改。这样 df 仍旧会统计这个被删除的文件，使用 ` losf | grep delete ` 命令找到占用删除文件的进程，当进程被kill或者停止的时候，这些文件空间就会被释放

2. 预留空间，为了预防紧急情况，Linux ext 文件系统会预留部分硬盘空间，具体预留的数值可以通过 ` tune2fs -l [dev_name] | grep "Reserved block count" ` 看到，这里预留的空间会被 df 计算到已用空间中，从而导致 df 和 du 统计的数据不一致。如果需要跳转预留空间大小，可以使用 ` tune2fs -m [size] [dev_name] ` 进行调整

3. 重复挂载的目录。当我们将一个设备挂载在一个目录下，但是当前目录中已经有数据了，那么这一部分的数据不会被 du 感知，在文件系统中也看不到这些数据，但是这些数据又确实占用了磁盘空间，能够被 df 统计到。出现这样的情况，需要使用 ` fuser -km [dir] ` 杀死占用该目录的所有进程(小心操作)， 然后 ` umount [dir] ` 将该目录挂载的设备卸载，这时目录原来的数据就会出现，我们将其删除之后，再重新挂载设备即可

## 解决办法

```bash
lsof | grep delete #查看已经删除，但是仍然被进程占用没有释放空间的文件相关信息 
```


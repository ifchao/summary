___
- FileName: 20190121-MySQL日志.md
- Author: ihuangch -huangch96@qq.com
- Description: ---
- Create:2019-01-21 11:27:31
___

### MySQL日志
日志是MySQL数据库的重要组成部分。日志文件中记录着MySQL数据库运行期间发生的变化，也就是说用来
记录着MySQL数据库客户端连接状况、SQL语句的执行情况和错误信息等。当数据库遭到意外的损坏时，
可以通过日志文件查看出错的原因，并且可以通过日志文件进行数据恢复。

### MySQL日志分类
- 查询日志: query log(一般不开启)
- 慢查询日志: slow query log（查询未必真的很慢）
- 错误日志: error log (服务启动和关闭的正常日志也在这里面)
- 二进制日志: binary log（备份恢复复制都是依靠这个日志）
- 中继日志: relay log（MySQL复制架构种需要的日志文件）
- 事务日志: transaction log（支持事务存储引擎）
**查看日志相关的变量**:
```mysql
MariaDB [(none)]> show global variables like "%log%"\G
```

##### 1. 查询日志
查询日志，一般不开启，因为一个非常繁忙的数据库服务器，其查询会有很多，每一次都记录会导致系统
性能下降，而且会有额外的空间开销。MySQL默认没有开启这个日志。  
如果开启查询日志，包括show、set操作也会被记录，不仅仅是select语句。  
查询日志的相关变量:  
- general_log=ON|OFF				# 是否启用查询日志
- general_log_file=HOSTNAME.log  	# 日志文件名称(默认为主机名.log)
- log_output=FILE|TABLE|NONE 	   	# 日志输出格式
	- FILE: 记录于general_log_file种
	- TABLE: 记录于表种。MySQL库中会自动生成一个表记录
	- NONE: 不记录
	- TABLE和FILE可以同时出现，使用逗号分开

```mysql
MariaDB [(none)]> show global variables like "general_log";
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| general_log   | OFF   |
+---------------+-------+
1 row in set (0.01 sec)

MariaDB [(none)]> show global variables like "general_log_file";
+------------------+----------------+
| Variable_name    | Value          |
+------------------+----------------+
| general_log_file | centos-112.log |
+------------------+----------------+
1 row in set (0.00 sec)

MariaDB [(none)]> show global variables like "log_output";
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| log_output    | FILE  |
+---------------+-------+
1 row in set (0.01 sec)
```

##### 2. 慢查询日志
查询执行时长超过指定时长的查询，即为慢查询。这里的慢不一定是语句自身执行速度慢，如果一个操作
锁定了某张表，尤其是独占锁锁定了这张表，那么其他人对于这张表的查询阻塞掉了。但慢查询日志是
我们通常拿来定位系统上查询操作执行速度过慢时用到的一个评估工具。所以在生产环境中有时很有必要
启用慢查询日志。默认没有启用。
```mysql
MariaDB [(none)]> show global variables like "long_query_time";  # 执行多长时间的查询算是慢查询
+-----------------+-----------+
| Variable_name   | Value     |
+-----------------+-----------+
| long_query_time | 10.000000 |
+-----------------+-----------+
1 row in set (0.00 sec)

MariaDB [(none)]> show global variables like "slow_query_log"; # 是否启用慢查询日志
+----------------+-------+
| Variable_name  | Value |
+----------------+-------+
| slow_query_log | OFF   |
+----------------+-------+
1 row in set (0.00 sec)

MariaDB [(none)]> show global variables like "slow_query_log_file";  # 日志输出路径及名称
+---------------------+---------------------+
| Variable_name       | Value               |
+---------------------+---------------------+
| slow_query_log_file | centos-112-slow.log |
+---------------------+---------------------+
1 row in set (0.00 sec)

MariaDB [(none)]> show global variables like "log_slow_rate_limit"; # 记录慢查询日志的速率
+---------------------+-------+
| Variable_name       | Value |
+---------------------+-------+
| log_slow_rate_limit | 1     |
+---------------------+-------+
1 row in set (0.00 sec)

MariaDB [(none)]> show global variables like "log_slow_verbosity"; # 慢查询的详细信息
+--------------------+-------+
| Variable_name      | Value |
+--------------------+-------+
| log_slow_verbosity |       |
+--------------------+-------+
1 row in set (0.00 sec)
```
##### 3. 错误日志
- 记录mysqld启动和关闭过程中输出的事件信息
- mysqld运行中产生的错误信息
- event scheduler运行一个event时产生的日志信息
- 在主从复制架构中的从服务器上启动从服务器线程时产生的信息

```mysql
MariaDB [(none)]> show global variables like "log_error"; # 错误日志路径
+---------------+------------------------------+
| Variable_name | Value                        |
+---------------+------------------------------+
| log_error     | /var/log/mariadb/mariadb.log |
+---------------+------------------------------+
1 row in set (0.00 sec)

MariaDB [(none)]> show global variables like "log_warnings"; # 是否记录警告信息
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| log_warnings  | 1     |
+---------------+-------+
1 row in set (0.00 sec)

```

##### 4. 二进制日志
导致数据改变或者潜在导致数据改变的SQL语句;默认是二进制格式文件，不要使用`cat`打开二进制文件，
可能会导致数据损坏。可以使用`mysqlbinlog`查看。  
二进制日志能够基于过去某个数据集的基础上，把后续的所有操作重新跑一遍，能得到和此前第一次跑时
所得到的是一样的结果。日志文件名字以及存放路径都是可以定义的。
- show { binary | master } logs: 查看mysql自行管理使用的二进制文件
- show master status: 查看使用中的二进制日志文件
- show binlog events: 查看事件信息`help show binlog events`

二进制日志相关的服务器变量:
- sql_log_bin=ON|OFF: 是否记录二进制文件
- log_bin=/path/to/BIN_log: 记录的文件的位置
- bin_log_format=STATEMENT|ROW|MIXED: 二进制日志记录的格式
	- STATEMENT: 基于语句记录
	- ROW: 基于行记录
	- MIXED: 由mysql自动判断基于哪种方式记录
- max_binlog_size=1073741824: 单个二进制日志文件的最大体积，默认为1G
- expire_logs_days: 日志过期时长
- sync_binlog=1|0: 设定是否启动二进制日志同步功能



##### 
